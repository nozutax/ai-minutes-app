<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI議事録アプリ (Gemini 2.0 Flash)</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
        h1 { text-align: center; color: #4285f4; }
        .section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        input[type="password"] { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; margin-right: 10px; }
        .btn-blue { background-color: #4285f4; }
        .btn-red { background-color: #ea4335; }
        .btn-green { background-color: #34a853; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        textarea { width: 100%; height: 150px; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; margin-top: 10px; }
        #status { font-weight: bold; color: #4285f4; margin-top: 10px; }
        .error { color: #ea4335; }
        .note { font-size: 0.9em; color: #666; }
    </style>
</head>
<body>

    <h1>✨ AI議事録アプリ (Gemini 2.0)</h1>

    <!-- APIキー入力 -->
    <div class="section">
        <label>Gemini API Keyを入力してください:</label>
        <input type="password" id="apiKey" placeholder="AIza..." value="">
        <p class="note">※キーはブラウザ内でのみ使用され、外部サーバーには保存されません。</p>
    </div>

    <!-- 1. 録音 -->
    <div class="section">
        <h2>1. 録音</h2>
        <button id="startBtn" class="btn-blue" onclick="startRecording()">録音開始</button>
        <button id="stopBtn" class="btn-red" onclick="stopRecording()" disabled>停止＆文字起こし</button>
        <p id="status">待機中...</p>
    </div>

    <!-- 2. 確認 -->
    <div class="section">
        <h2>2. 文字起こし確認・修正</h2>
        <textarea id="transcriptionText" placeholder="ここに文字起こし結果が表示されます..."></textarea>
        <br><br>
        <button id="summarizeBtn" class="btn-green" onclick="generateMinutes()" disabled>この内容で議事録を作成</button>
    </div>

    <!-- 3. 結果 -->
    <div class="section">
        <h2>3. 議事録出力</h2>
        <textarea id="minutesText" placeholder="ここに議事録が出力されます..." readonly></textarea>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        
        // ▼▼▼ ここを変更しました ▼▼▼
        // 最新のGemini 2.0 Flash Experimentalモデルを指定
        // (もし将来2.5が出たらここを "gemini-2.5-flash" 等に変えてください)
        const MODEL_NAME = "gemini-2.5-flash"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        // 録音開始
        async function startRecording() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert("先にGemini API Keyを入力してください");
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = processAudioWithGemini;

                mediaRecorder.start();
                updateStatus("録音中...", false);
                toggleButtons(true);
            } catch (err) {
                alert("マイクの使用が許可されていません。");
                console.error(err);
            }
        }

        // 録音停止
        function stopRecording() {
            mediaRecorder.stop();
            updateStatus("音声データを処理中...", true);
            toggleButtons(false);
        }

        // Geminiで音声文字起こし
        async function processAudioWithGemini() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const apiKey = document.getElementById('apiKey').value;

            updateStatus("Gemini 2.0に送信中...（高速解析中）", true);

            try {
                // BlobをBase64に変換
                const base64Audio = await blobToBase64(audioBlob);
                // "data:audio/webm;base64," のプレフィックスを削除
                const cleanBase64 = base64Audio.split(',')[1];

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        parts: [
                            { text: "この音声ファイルを、発言内容をそのまま正確に日本語で文字起こししてください。余計な会話や相槌は含めても構いません。" },
                            {
                                inline_data: {
                                    mime_type: "audio/webm",
                                    data: cleanBase64
                                }
                            }
                        ]
                    }]
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                // 結果の抽出
                if (data.candidates && data.candidates[0].content) {
                     const transcript = data.candidates[0].content.parts[0].text;
                     document.getElementById('transcriptionText').value = transcript;
                     document.getElementById('summarizeBtn').disabled = false;
                     updateStatus("文字起こし完了。", false);
                } else {
                     throw new Error("Geminiからの応答が空でした。録音が短すぎる可能性があります。");
                }

            } catch (error) {
                updateStatus(`エラー: ${error.message}`, true);
                console.error(error);
            }
        }

        // Geminiで議事録作成
        async function generateMinutes() {
            const text = document.getElementById('transcriptionText').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!text) return;

            updateStatus("AIが議事録を作成中...", true);
            document.getElementById('summarizeBtn').disabled = true;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

            const prompt = `
            以下の会議の文字起こしテキストをもとに、簡潔な議事録を作成してください。
            マークダウン形式を使わず、プレーンテキストで見やすく出力してください。
            
            【形式】
            ・議題
            ・決定事項
            ・ネクストアクション

            【テキスト】
            ${text}
            `;

            try {
                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const summary = data.candidates[0].content.parts[0].text;
                document.getElementById('minutesText').value = summary;
                updateStatus("議事録作成完了！", false);

            } catch (error) {
                updateStatus(`エラー: ${error.message}`, true);
            } finally {
                document.getElementById('summarizeBtn').disabled = false;
            }
        }

        // Helper: Blob to Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function updateStatus(msg, isProcessing) {
            const el = document.getElementById('status');
            el.innerText = msg;
            el.className = isProcessing ? '' : (msg.includes('エラー') ? 'error' : '');
            el.style.color = isProcessing ? '#4285f4' : (msg.includes('エラー') ? '#ea4335' : '#333');
        }

        function toggleButtons(isRecording) {
            document.getElementById('startBtn').disabled = isRecording;
            document.getElementById('stopBtn').disabled = !isRecording;
        }
    </script>
</body>
</html>
